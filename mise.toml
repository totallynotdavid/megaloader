[settings]
python.uv_venv_auto = true

[tools]
python = "3.13.7"
uv = "0.9.11"
ruff = "0.14.6"
bun = "1.3.3"
biome = "2.3.7"

# Dependencies
[tasks.sync]
description = "Install all dependencies (workspace + API)"
run = [
  "uv sync --all-packages --extra dev",
  "cd apps/api && uv sync --extra dev",
]

[tasks.update]
description = "Update all dependencies"
alias = "u"
run = "uv sync --all-packages --extra dev -U"

[tasks.outdated]
description = "List outdated dependencies"
run = "uv pip list --outdated"

# Code quality
[tasks.format]
description = "Format and fix linting issues"
run = ["ruff format", "ruff check --fix"]

[tasks.lint]
description = "Run type checking on all packages"
run = ["uv run mypy --exclude apps/api .", "cd apps/api && uv run mypy ."]

[tasks.check]
description = "Quick pre-push checks: format, lint, test-unit, validate-snippets"
depends = ["format", "lint", "test-unit", "validate-snippets"]

# Testing
[tasks.test]
description = "Run all tests including live network tests (~100 secs)"
run = "uv run pytest packages/core/tests --run-live"

[tasks.test-unit]
description = "Run unit tests only (fast: <1 sec)"
run = "uv run pytest packages/core/tests/unit"

# Development: CLI
[tasks.dev-cli]
description = "Run CLI during development (e.g., mise run dev-cli -- extract <url>)"
run = "uv run megaloader"

# Development: API
[tasks.api-serve]
description = "Run local API server"
run = "uv run uvicorn index:app --reload" # pass '--host 0.0.0.0' to expose on local network
dir = "apps/api"

# Development: Docs
[tasks.docs-serve]
description = "Serve documentation locally"
run = [
  "bun install",
  "bun run docs:dev",
] # pass '--host' to expose the server in local network
dir = "apps/docs"

[tasks.docs-build]
description = "Build documentation"
run = ["bun install", "bun run docs:build"]
dir = "apps/docs"

[tasks.format-docs]
description = "Format docs with biome (Vue only, markdown not supported)"
run = [
  "biome format --write .",
  "bun x prettier \"**/*.md\" --write --print-width=80 --prose-wrap=always",
]
dir = "apps/docs"

[tasks.validate-snippets]
description = "Validate Python code snippets in documentation"
run = "uv run python scripts/validate-code-snippets.py"

# Logo
[tasks.generate-logo]
description = "Generate project logo as SVG"
run = "uv run python scripts/generate-logo.py"

# Build
[tasks.build-bin]
description = "Build CLI binary locally for testing (Windows only)"
run = [
  "uv pip install pyinstaller",
  "uv run pyinstaller --onefile --name megaloader-cli-windows --paths packages/core packages/cli/megaloader_cli/main.py",
]

# Deploy
[tasks.api-deploy]
description = "Deploy API to Vercel"
run = "vercel --prod"
dir = "apps/api"
